version: '3.8'

services:

  enroll-php-fpm:
    image: ${REGISTRY}:demo-php-fpm-${IMAGE_TAG}
    container_name: enroll-php-fpm
    restart: always
    environment:
      APP_ENV: test
      APP_DEBUG: 0
      DATABASE_URL: pgsql://app:secrect@enroll-db:5432/app
    volumes:
      - ./app/tests:/app/tests/
      - ./app/codeception.yml:/app/codeception.yml
    depends_on:
      - enroll-db
      - test-enroll-selenium

  enroll-db:
    image: postgres:15-alpine
    container_name: enroll-db
    restart: always
    environment:
      - POSTGRES_DB=app
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=secrect

  test-enroll-nginx:
    image: ${REGISTRY}:demo-nginx-${IMAGE_TAG}
    container_name: enroll-nginx
    restart: always
    depends_on:
      - enroll-php-fpm

  test-enroll-selenium:
    image: selenium/standalone-firefox:4.12.1-20230904
    shm_size: 2gb
    environment:
      # when a test fails, its connection will be closed by selenium in 30 seconds
      # also if a test doesn't send any commands in 30sec, its connection will be closed by selenium
      SE_NODE_SESSION_TIMEOUT: 30
      # to be able to run another test after one fails (with hanging still open connection)
      # we need to increase the number of sessions
      SE_NODE_MAX_SESSIONS: 10
      SE_NODE_OVERRIDE_MAX_SESSIONS: 'true'
      # for CI should be false
      START_XVFB: 'false'

  test-enroll-mail:
    image: mailhog/mailhog
    container_name: test-enroll-mail
